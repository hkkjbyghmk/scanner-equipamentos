<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Leitor Inteligente de Equipamentos</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Reset e base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: var(--dark);
    }
    
    .container {
      max-width: 900px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }
    
    /* Header */
    header {
      text-align: center;
      width: 100%;
      padding: 25px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    h1 {
      color: var(--primary);
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .subtitle {
      color: var(--gray);
      font-size: 16px;
      font-weight: 400;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Scanner area */
    .scanner-section {
      width: 100%;
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .section-title {
      font-size: 22px;
      color: var(--dark);
      margin-bottom: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .section-title i {
      color: var(--primary);
      font-size: 24px;
    }
    
    #qr-reader {
      width: 100% !important;
      max-width: 500px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid var(--primary);
    }
    
    .scanner-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
      flex-wrap: wrap;
    }
    
    /* Status do scanner */
    .scanner-status {
      text-align: center;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 12px;
      margin-top: 20px;
      color: #1976d2;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: var(--transition);
    }
    
    /* Card de informações do equipamento */
    .equipment-card {
      width: 100%;
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      margin-top: 10px;
      border-left: 5px solid var(--primary);
    }
    
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .info-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .info-label {
      font-size: 14px;
      color: var(--gray);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      padding: 12px 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #e9ecef;
      min-height: 50px;
      display: flex;
      align-items: center;
    }
    
    .info-value.auto-detected {
      border-left: 4px solid var(--success);
      background: #f8fff9;
    }
    
    .info-value.manual {
      border-left: 4px solid var(--warning);
    }
    
    /* Chip de categoria */
    .category-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 5px;
    }
    
    .category-computador {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .category-periferico {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .category-rede {
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .category-impressora {
      background: #fff3e0;
      color: #ef6c00;
    }
    
    .category-outros {
      background: #f5f5f5;
      color: #616161;
    }
    
    /* Botões */
    .buttons-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      width: 100%;
      margin-top: 10px;
    }
    
    .btn {
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #4cc9f0, #3ab5d9);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(76, 201, 240, 0.3);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f8961e, #e0871b);
      color: white;
    }
    
    .btn-warning:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(248, 150, 30, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f72585, #e02177);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(247, 37, 133, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    /* Notificações */
    .notification {
      width: 100%;
      padding: 18px;
      border-radius: 12px;
      margin: 15px 0;
      font-weight: 600;
      display: none;
      animation: slideIn 0.3s ease;
      border-left: 5px solid;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .notification.success {
      background: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
      display: block;
    }
    
    .notification.error {
      background: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
      display: block;
    }
    
    .notification.info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: #bee5eb;
      display: block;
    }
    
    /* Histórico */
    .history-section {
      width: 100%;
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      display: none;
    }
    
    .history-section.active {
      display: block;
    }
    
    .history-list {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }
    
    .history-item {
      padding: 18px;
      border-bottom: 1px solid #eee;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 15px;
      align-items: center;
      transition: var(--transition);
    }
    
    .history-item:hover {
      background: #f8f9fa;
    }
    
    .history-item:last-child {
      border-bottom: none;
    }
    
    .history-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: white;
    }
    
    .history-details {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .history-category {
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 20px;
      font-weight: 600;
      display: inline-block;
      width: fit-content;
    }
    
    /* Badge de confiança */
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .confidence-high {
      background: #d4edda;
      color: #155724;
    }
    
    .confidence-medium {
      background: #fff3cd;
      color: #856404;
    }
    
    .confidence-low {
      background: #f8d7da;
      color: #721c24;
    }
    
    /* Responsividade iPhone 16 Pro */
    @media only screen and (max-width: 430px) {
      body {
        padding: 15px;
      }
      
      .container {
        gap: 15px;
      }
      
      header, .scanner-section, .equipment-card, .history-section {
        padding: 20px;
        border-radius: 14px;
      }
      
      h1 {
        font-size: 26px;
        flex-direction: column;
        gap: 10px;
      }
      
      .btn {
        padding: 14px 18px;
        font-size: 15px;
      }
      
      .buttons-section {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .scanner-controls {
        flex-direction: column;
      }
      
      .info-value {
        font-size: 16px;
        padding: 10px 12px;
      }
      
      .card-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .history-item {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 10px;
      }
      
      .history-icon {
        margin: 0 auto;
      }
    }
    
    /* Modo paisagem */
    @media only screen and (max-height: 600px) and (orientation: landscape) {
      body {
        padding: 10px;
      }
      
      .container {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: flex-start;
      }
      
      .scanner-section {
        flex: 1;
        min-width: 300px;
      }
      
      .equipment-card {
        flex: 1;
        min-width: 300px;
      }
      
      header {
        width: 100%;
      }
    }
    
    /* Animações */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 0.5s ease;
    }
    
    @keyframes highlight {
      0% { background-color: #e8f5e9; }
      100% { background-color: #f8f9fa; }
    }
    
    .highlight {
      animation: highlight 2s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-robot"></i> Leitor Inteligente de Equipamentos</h1>
      <p class="subtitle">Sistema que identifica automaticamente marca, modelo e categoria a partir de códigos de série</p>
    </header>
    
    <div class="scanner-section">
      <div class="section-title">
        <i class="fas fa-qrcode"></i> Scanner de Códigos
      </div>
      <div id="qr-reader"></div>
      <div class="scanner-status" id="scannerStatus">
        <i class="fas fa-camera"></i> Scanner ativo - Aponte para um código
      </div>
      
      <div class="scanner-controls">
        <button id="toggleScannerBtn" class="btn btn-warning">
          <i class="fas fa-pause"></i> Pausar Scanner
        </button>
        <button id="flashToggleBtn" class="btn btn-secondary">
          <i class="fas fa-lightbulb"></i> Luz
        </button>
      </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <div class="equipment-card" id="equipmentCard" style="display: none;">
      <div class="section-title">
        <i class="fas fa-laptop"></i> Equipamento Identificado
      </div>
      
      <div class="card-grid">
        <div class="info-group">
          <div class="info-label">
            <i class="fas fa-tag"></i> Marca
            <span class="confidence-badge confidence-high" id="marcaConfidence">Alta</span>
          </div>
          <div class="info-value auto-detected" id="marcaValue">-</div>
        </div>
        
        <div class="info-group">
          <div class="info-label">
            <i class="fas fa-cube"></i> Modelo
            <span class="confidence-badge confidence-medium" id="modeloConfidence">Média</span>
          </div>
          <div class="info-value auto-detected" id="modeloValue">-</div>
        </div>
        
        <div class="info-group">
          <div class="info-label">
            <i class="fas fa-barcode"></i> Número de Série
          </div>
          <div class="info-value" id="serieValue">-</div>
        </div>
        
        <div class="info-group">
          <div class="info-label">
            <i class="fas fa-filter"></i> Categoria
            <span class="confidence-badge confidence-high" id="categoriaConfidence">Alta</span>
          </div>
          <div class="info-value auto-detected" id="categoriaValue">-</div>
          <div id="categoriaChip"></div>
        </div>
        
        <div class="info-group">
          <div class="info-label">
            <i class="fas fa-microchip"></i> Tipo
          </div>
          <div class="info-value auto-detected" id="tipoValue">-</div>
        </div>
        
        <div class="info-group">
          <div class="info-label">
            <i class="fas fa-calendar-alt"></i> Ano Aproximado
          </div>
          <div class="info-value auto-detected" id="anoValue">-</div>
        </div>
      </div>
      
      <div class="buttons-section" style="margin-top: 25px;">
        <button id="editarBtn" class="btn btn-warning">
          <i class="fas fa-edit"></i> Editar Dados
        </button>
        <button id="copiarBtn" class="btn btn-primary">
          <i class="fas fa-copy"></i> Copiar Tudo
        </button>
        <button id="salvarBtn" class="btn btn-success">
          <i class="fas fa-save"></i> Salvar no Banco
        </button>
      </div>
    </div>
    
    <div class="buttons-section">
      <button id="novoScanBtn" class="btn btn-primary">
        <i class="fas fa-sync-alt"></i> Novo Scan
      </button>
      <button id="limparBtn" class="btn btn-danger">
        <i class="fas fa-trash-alt"></i> Limpar Tudo
      </button>
      <button id="historicoBtn" class="btn btn-secondary">
        <i class="fas fa-history"></i> Histórico
      </button>
    </div>
    
    <div class="history-section" id="historySection">
      <div class="section-title">
        <i class="fas fa-history"></i> Histórico de Equipamentos
      </div>
      <div class="history-list" id="historyList">
        <!-- Itens do histórico serão inseridos aqui -->
      </div>
    </div>
  </div>

  <script>
    // Base de dados de identificação de equipamentos
    const equipmentDatabase = {
      marcas: {
        'APPLE': { nome: 'Apple', pais: 'EUA', confianca: 0.95 },
        'DELL': { nome: 'Dell', pais: 'EUA', confianca: 0.95 },
        'LENOVO': { nome: 'Lenovo', pais: 'China', confianca: 0.95 },
        'HP': { nome: 'HP', pais: 'EUA', confianca: 0.95 },
        'ASUS': { nome: 'ASUS', pais: 'Taiwan', confianca: 0.90 },
        'ACER': { nome: 'Acer', pais: 'Taiwan', confianca: 0.90 },
        'MSI': { nome: 'MSI', pais: 'Taiwan', confianca: 0.90 },
        'SAMSUNG': { nome: 'Samsung', pais: 'Coreia do Sul', confianca: 0.95 },
        'LG': { nome: 'LG', pais: 'Coreia do Sul', confianca: 0.90 },
        'TOSHIBA': { nome: 'Toshiba', pais: 'Japão', confianca: 0.85 },
        'SONY': { nome: 'Sony', pais: 'Japão', confianca: 0.90 },
        'MICROSOFT': { nome: 'Microsoft', pais: 'EUA', confianca: 0.90 },
        'RAZER': { nome: 'Razer', pais: 'EUA/Singapura', confianca: 0.85 },
        'LOGITECH': { nome: 'Logitech', pais: 'Suíça', confianca: 0.90 },
        'CANON': { nome: 'Canon', pais: 'Japão', confianca: 0.95 },
        'EPSON': { nome: 'Epson', pais: 'Japão', confianca: 0.90 },
        'BROTHER': { nome: 'Brother', pais: 'Japão', confianca: 0.90 },
        'XEROX': { nome: 'Xerox', pais: 'EUA', confianca: 0.90 },
        'INTEL': { nome: 'Intel', pais: 'EUA', confianca: 0.95 },
        'AMD': { nome: 'AMD', pais: 'EUA', confianca: 0.95 },
        'NVIDIA': { nome: 'NVIDIA', pais: 'EUA', confianca: 0.95 },
        'TP-LINK': { nome: 'TP-Link', pais: 'China', confianca: 0.90 },
        'D-LINK': { nome: 'D-Link', pais: 'Taiwan', confianca: 0.85 },
        'CISCO': { nome: 'Cisco', pais: 'EUA', confianca: 0.95 },
        'HUAWEI': { nome: 'Huawei', pais: 'China', confianca: 0.90 },
        'XIAOMI': { nome: 'Xiaomi', pais: 'China', confianca: 0.85 }
      },
      
      modelos: {
        'MACBOOK': { marca: 'APPLE', categoria: 'COMPUTADOR', tipo: 'Notebook', confianca: 0.90 },
        'IMAC': { marca: 'APPLE', categoria: 'COMPUTADOR', tipo: 'Desktop', confianca: 0.90 },
        'IPHONE': { marca: 'APPLE', categoria: 'CELULAR', tipo: 'Smartphone', confianca: 0.95 },
        'IPAD': { marca: 'APPLE', categoria: 'TABLET', tipo: 'Tablet', confianca: 0.90 },
        'XPS': { marca: 'DELL', categoria: 'COMPUTADOR', tipo: 'Notebook', confianca: 0.85 },
        'LATITUDE': { marca: 'DELL', categoria: 'COMPUTADOR', tipo: 'Notebook', confianca: 0.85 },
        'PRECISION': { marca: 'DELL', categoria: 'COMPUTADOR', tipo: 'Workstation', confianca: 0.85 },
        'INSPIRON': { marca: 'DELL', categoria: 'COMPUTADOR', tipo: 'Notebook', confianca: 0.80 },
        'THINKPAD': { marca: 'LENOVO', categoria: 'COMPUTADOR', tipo: 'Notebook', confianca: 0.90 },
        'IDEAPAD': { marca: 'LENOVO', categoria: 'COMPUTADOR', tipo: 'Notebook', confianca: 0.80 },
        'LEGION': { marca: 'LENOVO', categoria: 'COMPUTADOR', tipo: 'Notebook Gaming', confianca: 0.85 },
        'PIXEL': { marca: 'GOOGLE', categoria: 'CELULAR', tipo: 'Smartphone', confianca: 0.90 },
        'GALAXY': { marca: 'SAMSUNG', categoria: 'CELULAR', tipo: 'Smartphone', confianca: 0.90 },
        'SURFACE': { marca: 'MICROSOFT', categoria: 'COMPUTADOR', tipo: 'Tablet/Notebook', confianca: 0.85 },
        'G-SERIES': { marca: 'LOGITECH', categoria: 'PERIFERICO', tipo: 'Mouse/Teclado', confianca: 0.80 },
        'MX': { marca: 'LOGITECH', categoria: 'PERIFERICO', tipo: 'Mouse', confianca: 0.80 },
        'PIXMA': { marca: 'CANON', categoria: 'IMPRESSORA', tipo: 'Impressora Jato de Tinta', confianca: 0.85 },
        'LASERJET': { marca: 'HP', categoria: 'IMPRESSORA', tipo: 'Impressora Laser', confianca: 0.90 },
        'DESKJET': { marca: 'HP', categoria: 'IMPRESSORA', tipo: 'Impressora Jato de Tinta', confianca: 0.90 },
        'WORKFORCE': { marca: 'EPSON', categoria: 'IMPRESSORA', tipo: 'Multifuncional', confianca: 0.85 },
        'ARCHER': { marca: 'TP-LINK', categoria: 'REDE', tipo: 'Roteador', confianca: 0.80 },
        'AIRPORT': { marca: 'APPLE', categoria: 'REDE', tipo: 'Roteador', confianca: 0.85 },
        'GEFORCE': { marca: 'NVIDIA', categoria: 'COMPONENTE', tipo: 'Placa de Vídeo', confianca: 0.95 },
        'RYZEN': { marca: 'AMD', categoria: 'COMPONENTE', tipo: 'Processador', confianca: 0.95 },
        'CORE': { marca: 'INTEL', categoria: 'COMPONENTE', tipo: 'Processador', confianca: 0.95 }
      },
      
      padroesSerie: {
        'APPLE': { formato: /^[A-Z0-9]{10,12}$/, anoPos: 3, mesPos: 4, confianca: 0.85 },
        'DELL': { formato: /^[A-Z0-9]{7}$|^[A-Z0-9]{14}$/, anoPos: 4, confianca: 0.80 },
        'HP': { formato: /^[A-Z0-9]{10}$/, anoPos: 4, confianca: 0.75 },
        'LENOVO': { formato: /^[A-Z0-9]{8}$|^[A-Z0-9]{11}$/, anoPos: 4, confianca: 0.75 },
        'SAMSUNG': { formato: /^[A-Z0-9]{10,14}$/, anoPos: 4, confianca: 0.70 },
        'CANON': { formato: /^[0-9]{10,12}$/, anoPos: 2, confianca: 0.70 },
        'LOGITECH': { formato: /^[0-9]{10}$/, anoPos: 3, confianca: 0.65 }
      },
      
      categorias: {
        'COMPUTADOR': { 
          nome: 'Computador', 
          icon: 'fas fa-laptop',
          subcategorias: ['Notebook', 'Desktop', 'Workstation', 'Servidor', 'All-in-One']
        },
        'CELULAR': { 
          nome: 'Celular/Smartphone', 
          icon: 'fas fa-mobile-alt',
          subcategorias: ['Smartphone', 'Telefone Celular']
        },
        'TABLET': { 
          nome: 'Tablet', 
          icon: 'fas fa-tablet-alt',
          subcategorias: ['Tablet', 'iPad', 'Tablet Android']
        },
        'PERIFERICO': { 
          nome: 'Periférico', 
          icon: 'fas fa-keyboard',
          subcategorias: ['Teclado', 'Mouse', 'Monitor', 'Webcam', 'Caixa de Som']
        },
        'IMPRESSORA': { 
          nome: 'Impressora', 
          icon: 'fas fa-print',
          subcategorias: ['Laser', 'Jato de Tinta', 'Multifuncional', 'Plotter']
        },
        'REDE': { 
          nome: 'Rede', 
          icon: 'fas fa-network-wired',
          subcategorias: ['Roteador', 'Switch', 'Access Point', 'Modem']
        },
        'COMPONENTE': { 
          nome: 'Componente', 
          icon: 'fas fa-microchip',
          subcategorias: ['Processador', 'Placa de Vídeo', 'Memória RAM', 'HD/SSD']
        },
        'OUTROS': { 
          nome: 'Outros', 
          icon: 'fas fa-question-circle',
          subcategorias: ['Desconhecido']
        }
      }
    };

    // Estado da aplicação
    const state = {
      scannerActive: true,
      flashActive: false,
      currentEquipment: null,
      history: JSON.parse(localStorage.getItem('equipmentHistory')) || [],
      isScanning: false,
      editMode: false
    };

    // Elementos DOM
    const elements = {
      // Scanner
      scannerStatus: document.getElementById('scannerStatus'),
      toggleScannerBtn: document.getElementById('toggleScannerBtn'),
      flashToggleBtn: document.getElementById('flashToggleBtn'),
      
      // Notificação
      notification: document.getElementById('notification'),
      
      // Card do equipamento
      equipmentCard: document.getElementById('equipmentCard'),
      marcaValue: document.getElementById('marcaValue'),
      modeloValue: document.getElementById('modeloValue'),
      serieValue: document.getElementById('serieValue'),
      categoriaValue: document.getElementById('categoriaValue'),
      tipoValue: document.getElementById('tipoValue'),
      anoValue: document.getElementById('anoValue'),
      categoriaChip: document.getElementById('categoriaChip'),
      
      // Badges de confiança
      marcaConfidence: document.getElementById('marcaConfidence'),
      modeloConfidence: document.getElementById('modeloConfidence'),
      categoriaConfidence: document.getElementById('categoriaConfidence'),
      
      // Botões
      editarBtn: document.getElementById('editarBtn'),
      copiarBtn: document.getElementById('copiarBtn'),
      salvarBtn: document.getElementById('salvarBtn'),
      novoScanBtn: document.getElementById('novoScanBtn'),
      limparBtn: document.getElementById('limparBtn'),
      historicoBtn: document.getElementById('historicoBtn'),
      
      // Histórico
      historySection: document.getElementById('historySection'),
      historyList: document.getElementById('historyList')
    };

    let html5QrcodeScanner = null;

    // Sistema de identificação inteligente
    class EquipmentIdentifier {
      static identificarPorCodigo(codigo) {
        const resultado = {
          marca: { nome: 'Desconhecida', confianca: 0 },
          modelo: { nome: 'Desconhecido', confianca: 0 },
          serie: codigo,
          categoria: { nome: 'Outros', confianca: 0 },
          tipo: 'Desconhecido',
          ano: 'Desconhecido',
          identificado: false
        };
        
        // Tentar identificar por padrões conhecidos
        const partes = codigo.split(/[;,\-\s]/);
        
        // 1. Identificar marca (procura por siglas conhecidas)
        for (const parte of partes) {
          const parteUpper = parte.toUpperCase().trim();
          
          // Verifica se a parte corresponde a uma marca conhecida
          if (equipmentDatabase.marcas[parteUpper]) {
            resultado.marca = {
              nome: equipmentDatabase.marcas[parteUpper].nome,
              confianca: equipmentDatabase.marcas[parteUpper].confianca
            };
            resultado.identificado = true;
            break;
          }
          
          // Verifica se contém nome de marca
          for (const [marcaKey, marcaInfo] of Object.entries(equipmentDatabase.marcas)) {
            if (parteUpper.includes(marcaKey) || marcaKey.includes(parteUpper)) {
              resultado.marca = {
                nome: marcaInfo.nome,
                confianca: marcaInfo.confianca * 0.8 // Confiança reduzida
              };
              resultado.identificado = true;
              break;
            }
          }
          
          if (resultado.identificado) break;
        }
        
        // 2. Identificar modelo
        for (const parte of partes) {
          const parteUpper = parte.toUpperCase().trim();
          
          // Verifica modelo exato
          if (equipmentDatabase.modelos[parteUpper]) {
            const modeloInfo = equipmentDatabase.modelos[parteUpper];
            resultado.modelo = {
              nome: parte,
              confianca: modeloInfo.confianca
            };
            
            // Se ainda não identificou marca, tenta pela do modelo
            if (resultado.marca.confianca < 0.5) {
              resultado.marca = {
                nome: equipmentDatabase.marcas[modeloInfo.marca]?.nome || 'Desconhecida',
                confianca: modeloInfo.confianca * 0.9
              };
            }
            
            // Define categoria e tipo baseado no modelo
            resultado.categoria = {
              nome: equipmentDatabase.categorias[modeloInfo.categoria]?.nome || 'Outros',
              confianca: modeloInfo.confianca
            };
            resultado.tipo = modeloInfo.tipo;
            break;
          }
          
          // Verifica se contém nome de modelo
          for (const [modeloKey, modeloInfo] of Object.entries(equipmentDatabase.modelos)) {
            if (parteUpper.includes(modeloKey) || modeloKey.includes(parteUpper)) {
              resultado.modelo = {
                nome: parte,
                confianca: modeloInfo.confianca * 0.7
              };
              
              if (resultado.marca.confianca < 0.5) {
                resultado.marca = {
                  nome: equipmentDatabase.marcas[modeloInfo.marca]?.nome || 'Desconhecida',
                  confianca: modeloInfo.confianca * 0.6
                };
              }
              
              resultado.categoria = {
                nome: equipmentDatabase.categorias[modeloInfo.categoria]?.nome || 'Outros',
                confianca: modeloInfo.confianca * 0.7
              };
              resultado.tipo = modeloInfo.tipo;
              break;
            }
          }
        }
        
        // 3. Tentar extrair ano do número de série
        resultado.ano = this.extrairAnoSerie(codigo, resultado.marca.nome);
        
        // 4. Se ainda não identificou categoria, tenta por palavras-chave
        if (resultado.categoria.confianca < 0.5) {
          const categoriaDetectada = this.identificarCategoriaPorPalavrasChave(codigo);
          if (categoriaDetectada) {
            resultado.categoria = categoriaDetectada;
          }
        }
        
        return resultado;
      }
      
      static extrairAnoSerie(serie, marca) {
        // Remove caracteres não numéricos
        const numeros = serie.replace(/\D/g, '');
        
        if (numeros.length >= 6) {
          // Tenta padrões comuns: AAMMDD, YYMMDD, YYYYMM
          const ano2dig = parseInt(numeros.substring(0, 2));
          const ano4dig = parseInt(numeros.substring(0, 4));
          
          if (ano4dig >= 2000 && ano4dig <= new Date().getFullYear()) {
            return ano4dig.toString();
          } else if (ano2dig >= 0 && ano2dig <= 99) {
            return (2000 + ano2dig).toString();
          }
        }
        
        // Verifica padrões específicos por marca
        const marcaUpper = marca.toUpperCase();
        if (equipmentDatabase.padroesSerie[marcaUpper]) {
          const padrao = equipmentDatabase.padroesSerie[marcaUpper];
          if (padrao.formato.test(serie)) {
            const anoPos = padrao.anoPos;
            if (serie.length > anoPos) {
              const anoDig = serie.substring(anoPos, anoPos + 2);
              const ano = parseInt(anoDig);
              if (!isNaN(ano)) {
                return (2000 + ano).toString();
              }
            }
          }
        }
        
        return 'Desconhecido';
      }
      
      static identificarCategoriaPorPalavrasChave(texto) {
        const upperText = texto.toUpperCase();
        const palavrasChave = {
          'COMPUTADOR': ['LAPTOP', 'NOTEBOOK', 'DESKTOP', 'PC', 'WORKSTATION', 'SERVER', 'SERVIDOR'],
          'CELULAR': ['PHONE', 'MOBILE', 'SMARTPHONE', 'CELULAR', 'ANDROID', 'IOS'],
          'TABLET': ['TABLET', 'IPAD', 'TAB'],
          'PERIFERICO': ['MOUSE', 'KEYBOARD', 'TECLADO', 'MONITOR', 'WEBCAM', 'SPEAKER', 'CAIXA DE SOM'],
          'IMPRESSORA': ['PRINTER', 'IMPRESSORA', 'PRINT', 'LASER', 'INKJET'],
          'REDE': ['ROUTER', 'ROTEADOR', 'SWITCH', 'MODEM', 'ACCESS POINT', 'WIFI'],
          'COMPONENTE': ['CPU', 'GPU', 'RAM', 'HDD', 'SSD', 'PROCESSADOR', 'PLACA DE VÍDEO']
        };
        
        for (const [categoria, palavras] of Object.entries(palavrasChave)) {
          for (const palavra of palavras) {
            if (upperText.includes(palavra)) {
              return {
                nome: equipmentDatabase.categorias[categoria]?.nome || categoria,
                confianca: 0.7
              };
            }
          }
        }
        
        return null;
      }
      
      static getConfidenceBadge(confianca) {
        if (confianca >= 0.8) return { texto: 'Alta', classe: 'confidence-high' };
        if (confianca >= 0.6) return { texto: 'Média', classe: 'confidence-medium' };
        return { texto: 'Baixa', classe: 'confidence-low' };
      }
      
      static getCategoryChip(categoria) {
        const categoriaUpper = categoria.toUpperCase();
        for (const [key, info] of Object.entries(equipmentDatabase.categorias)) {
          if (info.nome.toUpperCase() === categoriaUpper || key === categoriaUpper) {
            return `category-${key.toLowerCase()}`;
          }
        }
        return 'category-outros';
      }
    }

    // Funções de UI
    function showNotification(message, type = 'info') {
      elements.notification.textContent = message;
      elements.notification.className = `notification ${type}`;
      
      if (type !== 'info') {
        setTimeout(() => {
          elements.notification.className = 'notification';
        }, 5000);
      }
    }

    function showEquipmentCard(equipment) {
      elements.equipmentCard.style.display = 'block';
      
      // Preenche os valores
      elements.marcaValue.textContent = equipment.marca.nome;
      elements.modeloValue.textContent = equipment.modelo.nome;
      elements.serieValue.textContent = equipment.serie;
      elements.categoriaValue.textContent = equipment.categoria.nome;
      elements.tipoValue.textContent = equipment.tipo;
      elements.anoValue.textContent = equipment.ano;
      
      // Atualiza badges de confiança
      const marcaBadge = EquipmentIdentifier.getConfidenceBadge(equipment.marca.confianca);
      elements.marcaConfidence.textContent = marcaBadge.texto;
      elements.marcaConfidence.className = `confidence-badge ${marcaBadge.classe}`;
      
      const modeloBadge = EquipmentIdentifier.getConfidenceBadge(equipment.modelo.confianca);
      elements.modeloConfidence.textContent = modeloBadge.texto;
      elements.modeloConfidence.className = `confidence-badge ${modeloBadge.classe}`;
      
      const categoriaBadge = EquipmentIdentifier.getConfidenceBadge(equipment.categoria.confianca);
      elements.categoriaConfidence.textContent = categoriaBadge.texto;
      elements.categoriaConfidence.className = `confidence-badge ${categoriaBadge.classe}`;
      
      // Atualiza chip de categoria
      const categoryClass = EquipmentIdentifier.getCategoryChip(equipment.categoria.nome);
      elements.categoriaChip.innerHTML = `
        <span class="category-chip ${categoryClass}">
          <i class="${equipmentDatabase.categorias[categoryClass.replace('category-', '').toUpperCase()]?.icon || 'fas fa-question-circle'}"></i>
          ${equipment.categoria.nome}
        </span>
      `;
      
      // Anima a entrada
      elements.equipmentCard.classList.add('pulse');
      setTimeout(() => {
        elements.equipmentCard.classList.remove('pulse');
      }, 500);
      
      state.currentEquipment = equipment;
    }

    function addToHistory(equipment) {
      const timestamp = new Date().toLocaleString('pt-BR');
      const historyItem = {
        ...equipment,
        timestamp,
        id: Date.now()
      };
      
      state.history.unshift(historyItem);
      if (state.history.length > 50) {
        state.history = state.history.slice(0, 50);
      }
      
      localStorage.setItem('equipmentHistory', JSON.stringify(state.history));
      updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
      elements.historyList.innerHTML = '';
      
      if (state.history.length === 0) {
        elements.historyList.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--gray);">
            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>Nenhum equipamento escaneado ainda</p>
          </div>
        `;
        return;
      }
      
      state.history.forEach(item => {
        const categoryClass = EquipmentIdentifier.getCategoryChip(item.categoria.nome);
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div class="history-icon" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
            <i class="${equipmentDatabase.categorias[categoryClass.replace('category-', '').toUpperCase()]?.icon || 'fas fa-question-circle'}"></i>
          </div>
          <div class="history-details">
            <strong>${item.marca.nome} ${item.modelo.nome}</strong>
            <div style="font-size: 14px; color: var(--gray); margin-top: 4px;">
              Série: ${item.serie} • ${item.tipo}
            </div>
            <span class="history-category ${categoryClass}" style="margin-top: 8px;">
              ${item.categoria.nome}
            </span>
          </div>
          <div style="font-size: 12px; color: #999; text-align: right;">
            ${item.timestamp}
          </div>
        `;
        elements.historyList.appendChild(div);
      });
    }

    // Funções do Scanner
    async function onScanSuccess(decodedText) {
      if (state.isScanning) return;
      state.isScanning = true;
      
      console.log("Código lido:", decodedText);
      
      // Identifica o equipamento
      const equipment = EquipmentIdentifier.identificarPorCodigo(decodedText);
      
      // Mostra no card
      showEquipmentCard(equipment);
      
      // Feedback ao usuário
      showNotification(`✅ ${equipment.marca.nome} ${equipment.modelo.nome} identificado!`, 'success');
      elements.scannerStatus.innerHTML = `<i class="fas fa-check-circle"></i> Equipamento identificado - Scanner pausado`;
      elements.scannerStatus.style.background = '#d4edda';
      elements.scannerStatus.style.color = '#155724';
      
      // Adiciona ao histórico
      addToHistory(equipment);
      
      // Pausa o scanner temporariamente
      await stopScanner();
      
      // Reativa após 5 segundos
      setTimeout(() => {
        state.isScanning = false;
        if (state.scannerActive) {
          startScanner();
          elements.scannerStatus.innerHTML = `<i class="fas fa-camera"></i> Scanner reativado - Aponte para um código`;
          elements.scannerStatus.style.background = '#e3f2fd';
          elements.scannerStatus.style.color = '#1976d2';
        }
      }, 5000);
    }

    function onScanFailure(error) {
      console.warn("Erro no scanner:", error);
    }

    async function startScanner() {
      try {
        if (html5QrcodeScanner) {
          await html5QrcodeScanner.clear();
        }
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          rememberLastUsedCamera: true,
          formatsToSupport: [
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.CODE_39
          ]
        };
        
        html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config);
        await html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        // Ativa flash se configurado
        if (state.flashActive) {
          await toggleFlash();
        }
        
      } catch (error) {
        console.error("Erro ao iniciar scanner:", error);
        showNotification('❌ Erro ao acessar a câmera. Verifique as permissões.', 'error');
      }
    }

    async function stopScanner() {
      try {
        if (html5QrcodeScanner) {
          await html5QrcodeScanner.clear();
          html5QrcodeScanner = null;
        }
      } catch (error) {
        console.error("Erro ao parar scanner:", error);
      }
    }

    async function toggleFlash() {
      if (!html5QrcodeScanner) return;
      
      try {
        const cameras = await Html5Qrcode.getCameras();
        if (cameras && cameras.length > 0) {
          state.flashActive = !state.flashActive;
          
          if (state.flashActive) {
            await html5QrcodeScanner.applyVideoConstraints(cameras[0].id, {
              advanced: [{ torch: true }]
            });
            elements.flashToggleBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Luz (On)';
            showNotification('Luz da câmera ativada', 'info');
          } else {
            await html5QrcodeScanner.applyVideoConstraints(cameras[0].id, {
              advanced: [{ torch: false }]
            });
            elements.flashToggleBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Luz (Off)';
          }
        }
      } catch (error) {
        console.error("Erro ao controlar flash:", error);
      }
    }

    async function toggleScanner() {
      if (state.scannerActive) {
        await stopScanner();
        state.scannerActive = false;
        elements.toggleScannerBtn.innerHTML = '<i class="fas fa-play"></i> Retomar Scanner';
        elements.scannerStatus.innerHTML = `<i class="fas fa-pause-circle"></i> Scanner pausado - Clique em "Retomar Scanner"`;
        elements.scannerStatus.style.background = '#fff3cd';
        elements.scannerStatus.style.color = '#856404';
        showNotification('Scanner pausado', 'info');
      } else {
        state.scannerActive = true;
        await startScanner();
        elements.toggleScannerBtn.innerHTML = '<i class="fas fa-pause"></i> Pausar Scanner';
        showNotification('Scanner reativado', 'info');
      }
    }

    // Funções utilitárias
    async function copyToClipboard() {
      if (!state.currentEquipment) {
        showNotification('⚠️ Nenhum equipamento para copiar', 'error');
        return;
      }
      
      const texto = `
Equipamento Identificado:
Marca: ${state.currentEquipment.marca.nome}
Modelo: ${state.currentEquipment.modelo.nome}
Número de Série: ${state.currentEquipment.serie}
Categoria: ${state.currentEquipment.categoria.nome}
Tipo: ${state.currentEquipment.tipo}
Ano Aproximado: ${state.currentEquipment.ano}
Confiança: Marca (${EquipmentIdentifier.getConfidenceBadge(state.currentEquipment.marca.confianca).texto}), 
           Modelo (${EquipmentIdentifier.getConfidenceBadge(state.currentEquipment.modelo.confianca).texto})
      `.trim();
      
      try {
        await navigator.clipboard.writeText(texto);
        showNotification('✅ Dados copiados para a área de transferência!', 'success');
        elements.copiarBtn.classList.add('pulse');
        setTimeout(() => elements.copiarBtn.classList.remove('pulse'), 500);
      } catch (err) {
        showNotification('❌ Erro ao copiar. Tente novamente.', 'error');
      }
    }

    function clearAll() {
      if (confirm('Tem certeza que deseja limpar todos os dados?')) {
        elements.equipmentCard.style.display = 'none';
        state.currentEquipment = null;
        showNotification('Dados limpos. Pronto para novo scan.', 'info');
        elements.scannerStatus.innerHTML = `<i class="fas fa-camera"></i> Scanner ativo - Aponte para um código`;
        elements.scannerStatus.style.background = '#e3f2fd';
        elements.scannerStatus.style.color = '#1976d2';
      }
    }

    function toggleHistory() {
      const isVisible = elements.historySection.classList.toggle('active');
      elements.historicoBtn.innerHTML = isVisible 
        ? '<i class="fas fa-times"></i> Fechar Histórico'
        : '<i class="fas fa-history"></i> Histórico';
      
      if (isVisible) {
        updateHistoryDisplay();
      }
    }

    // Inicialização
    async function init() {
      // Carrega histórico
      updateHistoryDisplay();
      
      // Inicia scanner
      await startScanner();
      
      // Event Listeners
      elements.toggleScannerBtn.addEventListener('click', toggleScanner);
      elements.flashToggleBtn.addEventListener('click', toggleFlash);
      elements.copiarBtn.addEventListener('click', copyToClipboard);
      elements.salvarBtn.addEventListener('click', () => {
        if (state.currentEquipment) {
          showNotification('✅ Equipamento salvo no banco de dados!', 'success');
        }
      });
      elements.novoScanBtn.addEventListener('click', clearAll);
      elements.limparBtn.addEventListener('click', clearAll);
      elements.historicoBtn.addEventListener('click', toggleHistory);
      
      // Modo edição (simplificado)
      elements.editarBtn.addEventListener('click', () => {
        if (state.currentEquipment) {
          const novaMarca = prompt("Editar Marca:", state.currentEquipment.marca.nome);
          if (novaMarca) {
            state.currentEquipment.marca.nome = novaMarca;
            state.currentEquipment.marca.confianca = 0.5; // Confiança reduzida ao editar manualmente
            showEquipmentCard(state.currentEquipment);
            showNotification('Marca atualizada manualmente', 'info');
          }
        }
      });
      
      // Feedback inicial
      showNotification('Sistema pronto! Aponte a câmera para um código de equipamento.', 'info');
      
      // Configura hotkeys
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') elements.historySection.classList.remove('active');
        if (e.key === ' ' && e.target === document.body) e.preventDefault(); // Previne scroll com espaço
      });
    }

    // Inicializa a aplicação
    document.addEventListener('DOMContentLoaded', init);
    
    // Limpeza ao fechar
    window.addEventListener('beforeunload', () => {
      if (html5QrcodeScanner) {
        stopScanner();
      }
    });
  </script>
</body>
</html>